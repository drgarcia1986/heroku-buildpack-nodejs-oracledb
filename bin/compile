#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

BUILD_DIR=$1

indent() {
    echo "       $*" || true
}

indent "set environment variables..."
export ORACLE_HOME=$BUILD_DIR/.apt/usr/lib/oracle/12.1/client64
export OCI_HOME=$BUILD_DIR/.apt/usr/lib/oracle/12.1/client64
export OCI_LIB_DIR=$BUILD_DIR/.apt/usr/lib/oracle/12.1/client64/lib
export OCI_INCLUDE_DIR=$BUILD_DIR/.apt/usr/lib/oracle/12.1/client64/include
export OCI_VERSION="12"
export NLS_LANG=AMERICAN_AMERICA.UTF8
export OCI_INC_DIR=$BUILD_DIR/.apt/usr/include/oracle/12.1/client64/
export LD_LIBRARY_PATH=$BUILD_DIR/.apt/lib/

indent "Instal oracledb lib"
THIS_DIR=`pwd`
cd $BUILD_DIR
npm install oracledb --save
cd $THIS_DIR

indent "Saving environment setup script... "
PROFILE_DIR=$BUILD_DIR/.profile.d
mkdir -p $PROFILE_DIR
cat <<EOF >$PROFILE_DIR/oracle.sh
export ORACLE_HOME=\$HOME/.apt/usr/lib/oracle/12.1/client64
export OCI_HOME=\$HOME/.apt/usr/lib/oracle/12.1/client64
export OCI_LIB_DIR=\$HOME/.apt/usr/lib/oracle/12.1/client64/lib
export OCI_INCLUDE_DIR=\$HOME/.apt/usr/lib/oracle/12.1/client64/include
export OCI_INC_DIR=\$HOME/.apt/usr/include/oracle/12.1/client64/
export LD_LIBRARY_PATH=\$HOME/.apt/lib/
EOF

indent "Done."
